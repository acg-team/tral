
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tral.repeat.repeat &#8212; TRAL 2.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/tral.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700|Source+Code+Pro|Armata|IM+Fell+English'
          rel='stylesheet' type='text/css' />
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>
    <script type="text/javascript">
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

  </head><body>
<div class="pageheader">
    <a href="http://www.isb-sib.ch/" class="sib_logo" title="SIB Swiss Institute of Bioinformatics"><img src="../../../_static/sib.png" alt="SIB" class="sib_logo" /></a>
    <a href="../../../index.html">
      <img class="headlogo" src="../../../_static/trallogo.png" alt="TRAL" />
      <span class="headlogo">Tandem Repeat Annotation Library</span>
    </a>
    <div class="headlinks">
        <a href="../../../index.html">Home</a>
        <a href="../../../install.html">Install</a>
        <a href="../../../code_docs.html">Code docs</a>
    </div>
</div>


      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for tral.repeat.repeat</h1><div class="highlight"><pre>
<span></span><span class="c1"># (C) 2011, Alexander Korsunsky</span>
<span class="c1"># (C) 2011-2015 Elke Schaper</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :synopsis: The Repeat Class.</span>

<span class="sd">    .. moduleauthor:: Elke Schaper &lt;elke.schaper@isb-sib.ch&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">tral.repeat</span> <span class="kn">import</span> <span class="n">repeat_score</span><span class="p">,</span> <span class="n">repeat_pvalue</span><span class="p">,</span> <span class="n">repeat_io</span><span class="p">,</span> <span class="n">repeat_align</span>
<span class="kn">from</span> <span class="nn">tral</span> <span class="kn">import</span> <span class="n">configuration</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">CONFIG_GENERAL</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">config</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="n">CONFIG_GENERAL</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span>

<span class="c1"># ################ Repeat class ###############################################</span>


<div class="viewcode-block" id="Repeat"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.Repeat">[docs]</a><span class="k">class</span> <span class="nc">Repeat</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot; Tandem repeats are consecutive copies of genomic sequence.</span>

<span class="sd">    A tandem repeat is stored in terms of a multiple sequence alignment of its</span>
<span class="sd">    tandem repeat units. For example, the amino acid tandem repeat</span>
<span class="sd">    KLMKLMKLKLM</span>
<span class="sd">    can be displayed as a multiple sequence alignment (here: &quot;multiple repeat</span>
<span class="sd">    unit alignment&quot;)</span>
<span class="sd">    KLM</span>
<span class="sd">    KLM</span>
<span class="sd">    KL-</span>
<span class="sd">    KLM</span>
<span class="sd">    and can be stored as</span>
<span class="sd">    [&quot;KLM&quot;, &quot;KLM&quot;, &quot;KL-&quot;, &quot;KLM&quot;].</span>
<span class="sd">    The - char stands for a gap: It indicates that either, there used to be a</span>
<span class="sd">    char at the same position, but it got deleted. Or, all other chars in the</span>
<span class="sd">    same column got inserted at some point.</span>

<span class="sd">    For research on tandem repeats, many different statistics need to be</span>
<span class="sd">    calculated on the multiple sequence alignment of the tandem repeat.</span>

<span class="sd">    [Description of these statistics]</span>

<span class="sd">    Attributes:</span>
<span class="sd">        msa_original (list of str): The original alignment of repeat units.</span>
<span class="sd">        msa (list of str):  The alignment of repeat units without rare chars.</span>
<span class="sd">        msaT (list of str): The transposed alignment of repeat units. E.g.</span>
<span class="sd">            [&quot;KKKK&quot;, &quot;LLLL&quot;, &quot;MM-M&quot;].</span>
<span class="sd">        sequence_type (str): &quot;AA&quot; or &quot;DNA&quot;</span>
<span class="sd">        n (int): The number of repeat units in the original msa. E.g. 4.</span>
<span class="sd">        l_msa (int): The length of the repeat units in the original msa.</span>
<span class="sd">                     E.g. 3.</span>
<span class="sd">        l_effective (int): The number of columns in the original msa not</span>
<span class="sd">                           counting insertion columns (i.e. columns with more</span>
<span class="sd">                           gaps than chars).</span>
<span class="sd">        n_effective (float): The number of chars in the MSA without insertion</span>
<span class="sd">                             columns divided by n_effective.</span>
<span class="sd">        text (str): The repeat region of the tandem repeats (e.g. all chars in</span>
<span class="sd">                    the MSA without gaps concatenated.)</span>
<span class="sd">        n_gaps (int): The number of gaps in ``msa``</span>
<span class="sd">        repeat_region_length (int): The lengths of *text*</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create string for Repeat instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">first_line</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;begin&#39;</span><span class="p">):</span>
            <span class="n">first_line</span> <span class="o">+=</span> <span class="s2">&quot; begin:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;l_effective&#39;</span><span class="p">):</span>
            <span class="n">first_line</span> <span class="o">+=</span> <span class="s2">&quot; l_effective:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">):</span>
            <span class="n">first_line</span> <span class="o">+=</span> <span class="s2">&quot; n:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;d_pvalue&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;scoreslist&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">:</span>
                <span class="n">pvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;scoreslist&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;scoreslist&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">divergence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">divergence</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">first_line</span> <span class="o">+=</span> <span class="s2">&quot; pvalue:</span><span class="si">{0}</span><span class="s2"> divergence:</span><span class="si">{1}</span><span class="s2">&quot;</span> \
                          <span class="s2">&quot; type:</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pvalue</span><span class="p">,</span> <span class="n">divergence</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">first_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">)</span>

<div class="viewcode-block" id="Repeat.create"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.Repeat.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">input_format</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read tandem repeat from file.</span>

<span class="sd">        Read tandem repeat from file (currently, only pickle is supported)</span>

<span class="sd">        Args:</span>
<span class="sd">            format (str):  Currently only &quot;pickle&quot;</span>
<span class="sd">            file (str): Path to output file</span>

<span class="sd">        .. todo:: Write checks for ``format`` and ``file``.</span>
<span class="sd">        .. todo:: Write tests.</span>
<span class="sd">        .. todo:: Can repeat_io.read_fasta be replaced by e.g. BioPython seqIO?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">input_format</span> <span class="o">==</span> <span class="s1">&#39;pickle&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">input_format</span> <span class="o">==</span> <span class="s1">&#39;fasta&#39;</span><span class="p">:</span>
            <span class="n">l_repeat</span> <span class="o">=</span> <span class="n">repeat_io</span><span class="o">.</span><span class="n">read_fasta</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">Repeat</span><span class="p">(</span><span class="n">msa</span><span class="o">=</span><span class="n">i_msa</span><span class="p">,</span> <span class="n">sequence_type</span><span class="o">=</span><span class="n">i_sequence_type</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i_msa</span><span class="p">,</span> <span class="n">i_sequence_type</span> <span class="ow">in</span> <span class="n">l_repeat</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">input_format</span> <span class="o">==</span> <span class="s1">&#39;simulate&#39;</span><span class="p">:</span>
            <span class="n">l_repeat</span> <span class="o">=</span> <span class="n">repeat_io</span><span class="o">.</span><span class="n">random_sequence</span><span class="p">(</span><span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;repeat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">Repeat</span><span class="p">(</span><span class="n">msa</span><span class="o">=</span><span class="n">i_msa</span><span class="p">,</span> <span class="n">sequence_type</span><span class="o">=</span><span class="n">i_sequence_type</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i_msa</span><span class="p">,</span> <span class="n">i_sequence_type</span> <span class="ow">in</span> <span class="n">l_repeat</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;input_format is unknown: </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_format</span><span class="p">))</span></div>

<div class="viewcode-block" id="Repeat.write"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.Repeat.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">file_format</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write tandem repeat to file.</span>

<span class="sd">        Write tandem repeat to file using one of three formats.</span>

<span class="sd">        Args:</span>
<span class="sd">            file (str): Path to input file</span>
<span class="sd">            file_format (str):  Either &quot;fasta&quot;, &quot;pickle&quot; or &quot;stockholm&quot;</span>

<span class="sd">        .. todo:: Write checks for ``format`` and ``file``.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s1">&#39;fasta&#39;</span><span class="p">:</span>
            <span class="n">repeat_io</span><span class="o">.</span><span class="n">save_repeat_fasta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s1">&#39;pickle&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s1">&#39;stockholm&#39;</span><span class="p">:</span>
            <span class="n">repeat_io</span><span class="o">.</span><span class="n">save_repeat_stockholm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;file_format is unknown: </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_format</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;d_score&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">score_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_scores</span><span class="p">(</span><span class="n">scoreslist</span><span class="o">=</span><span class="p">[</span><span class="n">score_type</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">score_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span><span class="n">score_type</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;d_pvalue&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">score_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_pvalues</span><span class="p">(</span><span class="n">scoreslist</span><span class="o">=</span><span class="p">[</span><span class="n">score_type</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">score_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="n">score_type</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">divergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s1">&#39;d_divergence&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">score_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_scores</span><span class="p">(</span><span class="n">scoreslist</span><span class="o">=</span><span class="p">[</span><span class="n">score_type</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">score_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">[</span><span class="n">score_type</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msa</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sequence_type</span><span class="o">=</span><span class="n">CONFIG_GENERAL</span><span class="p">[</span><span class="s2">&quot;sequence_type&quot;</span><span class="p">],</span>
                 <span class="n">scoreslist</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;scoreslist&#39;</span><span class="p">],</span>
                 <span class="n">calc_score</span><span class="o">=</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">as_bool</span><span class="p">(</span><span class="s1">&#39;calc_score&#39;</span><span class="p">),</span>
                 <span class="n">calc_pvalue</span><span class="o">=</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">as_bool</span><span class="p">(</span><span class="s1">&#39;calc_pvalue&#39;</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. todo:: if calc_score == False and calc_pvalue == True, there is an</span>
<span class="sd">            error. However, calc_pvalue == True should automatically require</span>
<span class="sd">            the score to be calculated.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msa</span><span class="p">)</span>

        <span class="c1"># The index of begin start out on Zero.</span>
        <span class="k">if</span> <span class="n">begin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">=</span> <span class="n">begin</span>

        <span class="c1"># Replace underscores and asterisks with scores, transform letters to</span>
        <span class="c1"># uppercase, replace Selenocysteine (U) with Cysteine (C),</span>
        <span class="c1"># replace Pyrrolysine (O) with Lysine (K).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msa</span> <span class="o">=</span> <span class="p">[</span><span class="n">repeat_unit</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">repeat_unit</span> <span class="ow">in</span> <span class="n">msa</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_type</span> <span class="o">=</span> <span class="n">sequence_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">msa_standard_aa</span> <span class="o">=</span> <span class="p">[</span><span class="n">standardize</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_msa</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">))</span>

        <span class="c1"># Assure every line is equally long</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iMSA</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_msa</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">iMSA</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Constructing repeat from MSA:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">))</span>

        <span class="c1"># Transpose MSA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msaT</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">)]</span>

        <span class="c1"># Get text for MSA.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_gaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeat_region_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_gaps</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delete_insertion_columns</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gap_structure</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">calc_score</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_scores</span><span class="p">(</span><span class="n">scoreslist</span><span class="o">=</span><span class="n">scoreslist</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">calc_pvalue</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_pvalues</span><span class="p">(</span><span class="n">scoreslist</span><span class="o">=</span><span class="n">scoreslist</span><span class="p">)</span>

<div class="viewcode-block" id="Repeat.calc_n_effective"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.Repeat.calc_n_effective">[docs]</a>    <span class="k">def</span> <span class="nf">calc_n_effective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate the effective number of repeat units n_effective</span>

<span class="sd">        Calculate the number of letters in in all non-insertion columns,</span>
<span class="sd">        divided by &lt;l_effective&gt;</span>

<span class="sd">        Args:</span>
<span class="sd">            self (Repeat instance)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_effective</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msaD</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">textD_standard_aa</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_effective</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Repeat.calc_index_msa"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.Repeat.calc_index_msa">[docs]</a>    <span class="k">def</span> <span class="nf">calc_index_msa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; formerly named: set_begin&#39;&#39;&#39;</span>

        <span class="c1"># Calculate the transposed MSA with the index in protein sequence</span>
        <span class="c1"># instead of letter to be able to compare two overlapping Repeats</span>
        <span class="c1"># within the same sequence region.</span>
        <span class="c1"># python 2: range returns list by default</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat_region_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Replace every letter with the index in the protein sequence</span>
        <span class="n">msaI</span> <span class="o">=</span> <span class="p">[[</span><span class="n">j</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="k">else</span> <span class="n">index</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">]</span>  <span class="c1"># the &#39;I&#39; stands for index</span>
        <span class="c1"># Transpose msaI using list-comprehensions/zip/join magic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msaIT</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">c</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">msaI</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msaIT</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">msaIT</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Repeat.calculate_scores"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.Repeat.calculate_scores">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scoreslist</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;scoreslist&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot; Calculate scores on a Repeat instance.</span>

<span class="sd">        Calculate scores on a Repeat instance for all scores in `scoreslist`.</span>

<span class="sd">        Args:</span>
<span class="sd">            self (Repeat): An instance of the repeat class.</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            scoreslist(list of str): A list of the names of the scores (e.g.</span>
<span class="sd">             [&quot;phylo_gap01&quot;]) that are calculated on the Repeat instance `self`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;d_score&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;d_divergence&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">worst_score</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;entropy&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;parsimony&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;pSim&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;phylo&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;phylo_gap01&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;phylo_gap001&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Enter worst score</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">iScore</span><span class="p">:</span> <span class="n">worst_score</span><span class="p">[</span><span class="n">iScore</span><span class="p">]</span> <span class="k">for</span> <span class="n">iScore</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">}</span>
        <span class="c1"># Enter None, as a score cannot be calculated if there is just one</span>
        <span class="c1"># repeat unit.</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span> <span class="o">=</span> <span class="p">{</span><span class="n">iScore</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">iScore</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># Calculate score</span>
            <span class="k">if</span> <span class="s1">&#39;entropy&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span><span class="s1">&#39;entropy&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_score</span><span class="o">.</span><span class="n">mean_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repeat_score</span><span class="o">.</span><span class="n">entropy</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;parsimony&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span><span class="s1">&#39;parsimony&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="n">repeat_score</span><span class="o">.</span><span class="n">mean_similarity</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="n">repeat_score</span><span class="o">.</span><span class="n">parsimony</span><span class="p">),</span>
                    <span class="n">decimals</span><span class="o">=</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">as_int</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;pSim&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span><span class="s1">&#39;pSim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="n">repeat_score</span><span class="o">.</span><span class="n">mean_similarity</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="n">repeat_score</span><span class="o">.</span><span class="n">pSim</span><span class="p">),</span>
                    <span class="n">decimals</span><span class="o">=</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">as_int</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;phylo&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">[</span><span class="s1">&#39;phylo&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span><span class="s1">&#39;phylo&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_score</span><span class="o">.</span><span class="n">phylo_star_topology_local</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap01&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">[</span><span class="s1">&#39;phylo_gap01&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span><span class="s1">&#39;phylo_gap01&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_score</span><span class="o">.</span><span class="n">phylo_star_topology_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                           <span class="n">gaps</span><span class="o">=</span><span class="s1">&#39;row_wise&#39;</span><span class="p">,</span>
                                                           <span class="n">indel_rate_per_site</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap01_ignore_trailing_gaps&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">[</span><span class="s1">&#39;phylo_gap01_ignore_trailing_gaps&#39;</span><span class="p">],</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span><span class="s1">&#39;phylo_gap01_ignore_trailing_gaps&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_score</span><span class="o">.</span><span class="n">phylo_star_topology_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gaps</span><span class="o">=</span><span class="s1">&#39;ignore_trailing_gaps&#39;</span><span class="p">,</span> <span class="n">indel_rate_per_site</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap01_ignore_coherent_deletions&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">[</span><span class="s1">&#39;phylo_gap01_ignore_coherent_deletions&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span>
                    <span class="s1">&#39;phylo_gap01_ignore_coherent_deletions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repeat_score</span><span class="o">.</span><span class="n">phylo_star_topology_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gaps</span><span class="o">=</span><span class="s1">&#39;ignore_coherent_deletions&#39;</span><span class="p">,</span> <span class="n">indel_rate_per_site</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap01_ignore_trailing_gaps_and_coherent_deletions&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">[</span><span class="s1">&#39;phylo_gap01_ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">],</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span><span class="s1">&#39;phylo_gap01_ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_score</span><span class="o">.</span><span class="n">phylo_star_topology_local</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">gaps</span><span class="o">=</span><span class="s1">&#39;ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">,</span> <span class="n">indel_rate_per_site</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap001&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">[</span><span class="s1">&#39;phylo_gap001&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span><span class="s1">&#39;phylo_gap001&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repeat_score</span><span class="o">.</span><span class="n">phylo_star_topology_local</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">gaps</span><span class="o">=</span><span class="s1">&#39;row_wise&#39;</span><span class="p">,</span> <span class="n">indel_rate_per_site</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap001_ignore_trailing_gaps&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">[</span><span class="s1">&#39;phylo_gap001_ignore_trailing_gaps&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span>
                    <span class="s1">&#39;phylo_gap001_ignore_trailing_gaps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repeat_score</span><span class="o">.</span><span class="n">phylo_star_topology_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gaps</span><span class="o">=</span><span class="s1">&#39;ignore_trailing_gaps&#39;</span><span class="p">,</span> <span class="n">indel_rate_per_site</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap001_ignore_coherent_deletions&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">[</span><span class="s1">&#39;phylo_gap001_ignore_coherent_deletions&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span>
                    <span class="s1">&#39;phylo_gap001_ignore_coherent_deletions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repeat_score</span><span class="o">.</span><span class="n">phylo_star_topology_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gaps</span><span class="o">=</span><span class="s1">&#39;ignore_coherent_deletions&#39;</span><span class="p">,</span> <span class="n">indel_rate_per_site</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap001_ignore_trailing_gaps_and_coherent_deletions&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_divergence</span><span class="p">[</span><span class="s1">&#39;phylo_gap001_ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_score</span><span class="p">[</span>
                    <span class="s1">&#39;phylo_gap001_ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repeat_score</span><span class="o">.</span><span class="n">phylo_star_topology_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gaps</span><span class="o">=</span><span class="s1">&#39;ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">,</span> <span class="n">indel_rate_per_site</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span></div>

<div class="viewcode-block" id="Repeat.calculate_pvalues"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.Repeat.calculate_pvalues">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_pvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scoreslist</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;scoreslist&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot; Calculate pvalues on a Repeat instance.</span>

<span class="sd">        Calculate pvalues on a Repeat instance for all scores in `scoreslist`.</span>

<span class="sd">        Args:</span>
<span class="sd">            self (Repeat): An instance of the repeat class.</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            scoreslist(list of Str): A list of the names of the scores (e.g.</span>
<span class="sd">            [&quot;phylo_gap01&quot;]) for which p-Values are calculated on the</span>
<span class="sd">            Repeat instance `self`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">scoreslist</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please make sure that scoreslist is a list. &quot;</span>
                             <span class="s2">&quot;You can make this sure by a comma at the end of your Config-File.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;d_pvalue&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Enter worst p-value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span> <span class="o">=</span> <span class="p">{</span><span class="n">iScore</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">iScore</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">}</span>
        <span class="c1"># Enter None, as a pvalue cannot be calculated if there is just one</span>
        <span class="c1"># repeat unit.</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span> <span class="o">=</span> <span class="p">{</span><span class="n">iScore</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">iScore</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># Calculate score</span>
            <span class="k">if</span> <span class="s1">&#39;entropy&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;entropy&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_from_empirical_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;entropy&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;parsimony&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;parsimony&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;pSim&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;pSim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_psim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;phylo&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_from_empirical_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;phylo&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;phylo_gap&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_from_empirical_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;phylo_gap&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap01&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;phylo_gap01&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_from_empirical_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;phylo_gap01&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap01_ignore_trailing_gaps&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;phylo_gap01_ignore_trailing_gaps&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_from_empirical_list</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="s1">&#39;phylo_gap01&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s1">&#39;phylo_gap01_ignore_trailing_gaps&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap01_ignore_coherent_deletions&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;phylo_gap01_ignore_coherent_deletions&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_from_empirical_list</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="s1">&#39;phylo_gap01&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s1">&#39;phylo_gap01_ignore_coherent_deletions&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap01_ignore_trailing_gaps_and_coherent_deletions&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;phylo_gap01_ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_from_empirical_list</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="s1">&#39;phylo_gap01&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s1">&#39;phylo_gap01_ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap001&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;phylo_gap001&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_from_empirical_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                             <span class="s1">&#39;phylo_gap001&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap001_ignore_trailing_gaps&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;phylo_gap001_ignore_trailing_gaps&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_from_empirical_list</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="s1">&#39;phylo_gap001&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s1">&#39;phylo_gap001_ignore_trailing_gaps&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap001_ignore_coherent_deletions&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;phylo_gap001_ignore_coherent_deletions&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_from_empirical_list</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="s1">&#39;phylo_gap001&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s1">&#39;phylo_gap001_ignore_coherent_deletions&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;phylo_gap001_ignore_trailing_gaps_and_coherent_deletions&#39;</span> <span class="ow">in</span> <span class="n">scoreslist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_pvalue</span><span class="p">[</span><span class="s1">&#39;phylo_gap001_ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">repeat_pvalue</span><span class="o">.</span><span class="n">pvalue_from_empirical_list</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="s1">&#39;phylo_gap001&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="s1">&#39;phylo_gap001_ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Repeat.delete_insertion_columns"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.Repeat.delete_insertion_columns">[docs]</a>    <span class="k">def</span> <span class="nf">delete_insertion_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create the tandem repeat attributes `msa`, `masT`, `l` and `n`</span>
<span class="sd">            without insertion columns.</span>

<span class="sd">        We define insertion columns as columns where there are more or equal</span>
<span class="sd">        gaps compared to chars.</span>
<span class="sd">        These columns are removed from both `msa` to create `msaD` and `msaT`</span>
<span class="sd">        to create `msaTD`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># We define insertion columns as columns where there are more or equal</span>
        <span class="c1"># gaps compared to chars.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msaTD</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">msaT</span>
                      <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">column</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
                      <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insertions</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;-+&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s1">&#39;p&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">column</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">))</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">msaT</span>
        <span class="p">])</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">msaTD_standard_aa</span> <span class="o">=</span> <span class="p">[</span><span class="n">standardize</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">msaTD</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">msaD</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">msaTD</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msaTD</span><span class="p">)</span>
        <span class="n">textD</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msaD</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">textD_standard_aa</span> <span class="o">=</span> <span class="n">standardize</span><span class="p">(</span><span class="n">textD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_type</span><span class="p">)</span>
        <span class="c1"># totD is used in repeat_score</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totD</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">textD</span><span class="p">)</span> <span class="o">-</span> <span class="n">textD</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_effective</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msaD</span><span class="p">))</span> <span class="o">-</span> <span class="n">textD</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_effective</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Repeat.gap_structure"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.Repeat.gap_structure">[docs]</a>    <span class="k">def</span> <span class="nf">gap_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Calculate the number and length of insertions and deletions for</span>
<span class="sd">            this tandem repeat.&#39;&#39;&#39;</span>

        <span class="c1"># Needed: Number and size of insertions, number and size of deletions</span>
        <span class="c1"># row_wise: (standard case) column wise coherence is ignored, the</span>
        <span class="c1"># indels are summarised over the columns.</span>
        <span class="c1"># ignore_trailing_gaps: In addition to the standard case, trailing gaps</span>
        <span class="c1"># on either side of the tandem repeat are replaced with letters, and</span>
        <span class="c1"># hence ignored.</span>
        <span class="c1"># The separation into insertions and deletions comes before ignoring</span>
        <span class="c1"># trailing gaps.</span>
        <span class="c1"># ignore_coherent_deletions : In addition to the standard case, same</span>
        <span class="c1"># size deletions spanning the same columns are only counted once.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insertions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deletions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># row_wise</span>
        <span class="c1"># 1. Detect insertions</span>
        <span class="c1"># First, name columns either &#39;-&#39; if they are insertion columns, or &#39;p&#39;,</span>
        <span class="c1">#  if they are not.</span>
        <span class="c1"># Concetanate the string of &#39;p&#39;s and &#39;-&#39;, and double it, to consider</span>
        <span class="c1"># insertions in the last column</span>
        <span class="c1"># and the first column as associated (= of the same origin)</span>
        <span class="c1"># Lastly, detect the length of all insertions.</span>
        <span class="n">insertions</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;-+&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s1">&#39;p&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">column</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">))</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">msaT</span>
        <span class="p">])))</span>
        <span class="n">insertions</span> <span class="o">=</span> <span class="n">insertions</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">insertions</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">insertions</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">insertions</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">insertions</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insertions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">insertions</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insertions</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l_msa</span><span class="p">]</span>

        <span class="c1"># 2. Detect deletions</span>
        <span class="c1"># CHECK this lines. you used msaTD before, but swapped to msaD</span>
        <span class="n">deletions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_msa</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()))</span>
                     <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;-+&quot;</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msaD</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deletions</span><span class="p">[</span><span class="s1">&#39;row_wise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">deletions</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaps</span><span class="p">[</span><span class="s1">&#39;row_wise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertions</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">deletions</span><span class="p">[</span><span class="s1">&#39;row_wise&#39;</span><span class="p">]</span>

        <span class="c1"># ignore_coherent_deletions</span>
        <span class="c1"># Remove duplicates from the list of tuples(index of deletion, deletion</span>
        <span class="c1"># length)</span>
        <span class="n">deletions_ignore_coherent</span> <span class="o">=</span> <span class="p">{</span><span class="n">iD</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">iD</span> <span class="ow">in</span> <span class="n">deletions</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deletions</span><span class="p">[</span><span class="s1">&#39;ignore_coherent_deletions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">deletions_ignore_coherent</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaps</span><span class="p">[</span><span class="s1">&#39;ignore_coherent_deletions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertions</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">deletions</span><span class="p">[</span><span class="s1">&#39;ignore_coherent_deletions&#39;</span><span class="p">]</span>

        <span class="c1"># ignore_trailing_gaps</span>
        <span class="c1"># To be precise, we should ignore_trailing_gaps only, if we have</span>
        <span class="c1"># ascertained that there were no letters in possible insertion columns</span>
        <span class="c1"># before the first deletion column. For now, this case is ignored.</span>
        <span class="n">msaD</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msaD</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">sub_trailing_gap</span><span class="p">(</span><span class="n">match_object</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;x&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_object</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
        <span class="n">msaD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;^-+&#39;</span><span class="p">,</span> <span class="n">sub_trailing_gap</span><span class="p">,</span> <span class="n">msaD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">msaD</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;-+$&#39;</span><span class="p">,</span> <span class="n">sub_trailing_gap</span><span class="p">,</span> <span class="n">msaD</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># CHECK this lines. you used msaTD before, but swapped to msaD</span>
        <span class="c1"># msaTD = [&quot;&quot;.join(c) for c in zip(*msaD)]</span>
        <span class="n">deletions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_msa</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()))</span>
                     <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;-+&quot;</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msaD</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deletions</span><span class="p">[</span><span class="s1">&#39;ignore_trailing_gaps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">deletions</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaps</span><span class="p">[</span><span class="s1">&#39;ignore_trailing_gaps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertions</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">deletions</span><span class="p">[</span><span class="s1">&#39;ignore_trailing_gaps&#39;</span><span class="p">]</span>

        <span class="c1">## ignore_trailing_gaps &amp; ignore_coherent_deletions</span>
        <span class="n">deletions_ignore_coherent</span> <span class="o">=</span> <span class="p">{</span><span class="n">iD</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">iD</span> <span class="ow">in</span> <span class="n">deletions</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deletions</span><span class="p">[</span><span class="s1">&#39;ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">deletions_ignore_coherent</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaps</span><span class="p">[</span><span class="s1">&#39;ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insertions</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">deletions</span><span class="p">[</span><span class="s1">&#39;ignore_trailing_gaps_and_coherent_deletions&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Repeat.gap_structure_HMM"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.Repeat.gap_structure_HMM">[docs]</a>    <span class="k">def</span> <span class="nf">gap_structure_HMM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate for each column in the transposed multiple repeat unit</span>
<span class="sd">            alignment `msaTD`</span>

<span class="sd">            *   how many deletions of what length begin in this column?:</span>
<span class="sd">                 `deletion_lengths`[`iColumn`] = list of deletion lengths</span>
<span class="sd">            *   how many insertions of what length begin in potential insertion</span>
<span class="sd">                columns before this column?:</span>
<span class="sd">                `insertion_lengths`[`iColumn`] = list of insertion lengths</span>

<span class="sd">        Args:</span>
<span class="sd">            self (Repeat): An instance of the repeat class.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Insertions: In which column (with reference to self.msaTD) do how</span>
        <span class="c1"># many insertions of what length start?</span>
        <span class="c1"># In which columns are insertions?</span>
        <span class="n">insertions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span>
            <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msaT</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span>
                <span class="mi">2</span> <span class="o">*</span>
                <span class="n">column</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">column</span><span class="p">))]</span>

        <span class="c1"># Which insertions are neighboring == form a block, and on which index</span>
        <span class="c1"># with reference to self.msaTD do they start?</span>
        <span class="n">insertion_blocks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">n_insertion_columns</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">insertions</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">insertions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">insertion_blocks</span><span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;indices_self.msaT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">current</span><span class="p">]}</span>
            <span class="k">while</span> <span class="n">insertions</span> <span class="ow">and</span> <span class="n">insertions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">insertion_blocks</span><span class="p">[</span>
                    <span class="n">current</span><span class="p">][</span><span class="s1">&#39;indices_self.msaT&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">insertion_blocks</span><span class="p">[</span><span class="n">current</span><span class="p">][</span>
                    <span class="s1">&#39;indices_self.msaT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">insertions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">insertion_blocks</span><span class="p">[</span><span class="n">current</span><span class="p">][</span><span class="s1">&#39;index_self.msaTD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">insertion_blocks</span><span class="p">[</span>
                <span class="n">current</span><span class="p">][</span><span class="s1">&#39;indices_self.msaT&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">n_insertion_columns</span>
            <span class="n">n_insertion_columns</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">insertion_blocks</span><span class="p">[</span><span class="n">current</span><span class="p">][</span><span class="s1">&#39;indices_self.msaT&#39;</span><span class="p">])</span>

        <span class="c1"># If an insertions ranges over the repeat unit border, take the</span>
        <span class="c1"># insertion on both parts together:</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">insertion_blocks</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msaT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">insertion_blocks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">insertion_blocks</span><span class="p">[</span><span class="n">current</span><span class="p">][</span><span class="s1">&#39;indices_self.msaT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">insertion_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;indices_self.msaT&#39;</span><span class="p">])</span>
            <span class="n">insertion_blocks</span><span class="p">[</span><span class="n">current</span><span class="p">][</span>
                <span class="s1">&#39;index_self.msaTD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">insertion_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;index_self.msaTD&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">insertion_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Restructure insertion_blocks: We are only interested in the index</span>
        <span class="c1"># with reference to self.msaTD, and the start and end index with</span>
        <span class="c1"># reference to self.msaT:</span>
        <span class="n">insertion_blocks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">[</span><span class="s1">&#39;index_self.msaTD&#39;</span><span class="p">]:</span> <span class="p">(</span>
                <span class="n">i</span><span class="p">[</span><span class="s1">&#39;indices_self.msaT&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">i</span><span class="p">[</span><span class="s1">&#39;indices_self.msaT&#39;</span><span class="p">][</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">insertion_blocks</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>

        <span class="c1"># Go to each insertion block, and see how many insertion it includes,</span>
        <span class="c1"># and of what length.</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msaT</span><span class="p">)</span>
        <span class="n">insertion_lengths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">iL</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span><span class="p">):</span>
            <span class="n">insertion_lengths</span><span class="p">[</span><span class="n">iL</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">iL</span> <span class="ow">in</span> <span class="n">insertion_blocks</span><span class="p">:</span>
                <span class="n">begin</span> <span class="o">=</span> <span class="n">insertion_blocks</span><span class="p">[</span><span class="n">iL</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">insertion_blocks</span><span class="p">[</span><span class="n">iL</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">begin</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c1"># In case the insertion blocks bridges over then end of the</span>
                <span class="c1"># repeat unit:</span>
                <span class="k">if</span> <span class="n">begin</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">:</span>
                    <span class="n">length</span> <span class="o">+=</span> <span class="n">l</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>

                <span class="n">repeat_sequence</span> <span class="o">=</span> <span class="n">get_repeat_sequence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">insertion</span> <span class="o">=</span> <span class="n">repeat_sequence</span><span class="p">[</span>
                        <span class="n">i</span> <span class="o">*</span>
                        <span class="n">l</span> <span class="o">+</span>
                        <span class="n">begin</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">repeat_sequence</span><span class="p">),</span>
                            <span class="n">i</span> <span class="o">*</span>
                            <span class="n">l</span> <span class="o">+</span>
                            <span class="n">begin</span> <span class="o">+</span>
                            <span class="n">length</span><span class="p">)]</span>
                    <span class="n">insertion_lengths</span><span class="p">[</span><span class="n">iL</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">iI</span><span class="p">)</span> <span class="k">for</span> <span class="n">iI</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+&#39;</span><span class="p">,</span> <span class="n">insertion</span><span class="p">)])</span>

                <span class="c1"># In case the insertion blocks bridges over then end of the</span>
                <span class="c1"># repeat unit:</span>
                <span class="k">if</span> <span class="n">begin</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">:</span>
                    <span class="n">insertion</span> <span class="o">=</span> <span class="n">repeat_sequence</span><span class="p">[:</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">insertion_lengths</span><span class="p">[</span><span class="n">iL</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">iI</span><span class="p">)</span> <span class="k">for</span> <span class="n">iI</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+&#39;</span><span class="p">,</span> <span class="n">insertion</span><span class="p">)])</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;The insertion_lengths of the current TR are: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">insertion_lengths</span><span class="p">))</span>

        <span class="c1"># Deletions are much easier to handle than insertions, as they are</span>
        <span class="c1"># already in the right coordinate system (self.msaTD)</span>
        <span class="c1"># Find all deletions, and note their start index, and their lengths.</span>
        <span class="n">deletions_all</span> <span class="o">=</span> <span class="p">[(</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()))</span>
                         <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;-+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msaD</span><span class="p">))]</span>
        <span class="c1"># Group the deletions with respect to the column in which they start:</span>
        <span class="n">deletion_lengths</span> <span class="o">=</span> <span class="p">{</span><span class="n">iL</span><span class="p">:</span>
                            <span class="p">[</span><span class="n">iD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">iD</span> <span class="ow">in</span> <span class="n">deletions_all</span> <span class="k">if</span> <span class="n">iD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span> <span class="o">==</span> <span class="n">iL</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">iL</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_effective</span><span class="p">)}</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;The deletion_lengths of the current TR are: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deletion_lengths</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">insertion_lengths</span><span class="p">,</span> <span class="n">deletion_lengths</span></div>

<div class="viewcode-block" id="Repeat.save_original_msa"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.Repeat.save_original_msa">[docs]</a>    <span class="k">def</span> <span class="nf">save_original_msa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; recalculate the original msa, assuming that begin is defined</span>
<span class="sd">        correctly (index starting counting on 1.) This function might be</span>
<span class="sd">        obsolete when the original MSA is saved from the beginning.&#39;&#39;&#39;</span>
        <span class="n">repeat_sequence</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">-</span>
            <span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">-</span>
            <span class="mi">1</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repeat_region_length</span><span class="p">]</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msa_original</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">:</span>
            <span class="n">unit_original</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">unit</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">unit_original</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">unit_original</span> <span class="o">+=</span> <span class="n">repeat_sequence</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msa_original</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_original</span><span class="p">)</span></div>

<div class="viewcode-block" id="Repeat.realign_TR"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.Repeat.realign_TR">[docs]</a>    <span class="k">def</span> <span class="nf">realign_TR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">realignment</span><span class="o">=</span><span class="s1">&#39;proPIP&#39;</span><span class="p">,</span> <span class="n">rate_distribution</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;castor_parameter&#39;</span><span class="p">][</span><span class="s1">&#39;rate_distribution&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot; Realign multiple sequence alignment of tandem repeats.</span>
<span class="sd">            Update of tandem repeat MSA.</span>

<span class="sd">        Args:</span>
<span class="sd">            self (Repeat instance)</span>
<span class="sd">            realignment (str): either &quot;proPIP&quot; or &quot;mafft&quot;</span>
<span class="sd">            rate_distribution (str): either &quot;constant&quot; or &quot;gamma&quot; (per default value from REPEAT_CONFIG[&#39;castor_parameter&#39;][&#39;rate_distribution&#39;])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msa</span> <span class="o">=</span> <span class="n">repeat_align</span><span class="o">.</span><span class="n">realign_repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msa</span><span class="p">,</span>
                                               <span class="n">realignment</span><span class="p">,</span>
                                               <span class="n">sequence_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_type</span><span class="p">,</span>
                                               <span class="n">rate_distribution</span><span class="o">=</span><span class="n">rate_distribution</span><span class="p">)</span></div></div>

<span class="c1"># Standardize MSA #############################################################</span>


<span class="k">def</span> <span class="nf">standardize</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">sequence_type</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">CONFIG_GENERAL</span><span class="p">[</span><span class="n">sequence_type</span><span class="p">][</span>
            <span class="s1">&#39;ambiguous_chars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">replacement</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">blob</span>


<span class="k">def</span> <span class="nf">get_repeat_sequence</span><span class="p">(</span><span class="n">msa</span><span class="p">):</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">msa</span><span class="p">])</span>


<span class="c1"># Localize repeat #############################################################</span>


<div class="viewcode-block" id="calculate_position_in_alignment"><a class="viewcode-back" href="../../../tral/repeat.html#tral.repeat.repeat.calculate_position_in_alignment">[docs]</a><span class="k">def</span> <span class="nf">calculate_position_in_alignment</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">alignment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate the index of the begin and the end of a TR within an alignment</span>
<span class="sd">        returns</span>

<span class="sd">        Calculate the index of the begin and the end of a TR within an alignment</span>
<span class="sd">        returns</span>

<span class="sd">    Args:</span>
<span class="sd">        begin (int): (needs explaining)</span>
<span class="sd">        length (int): (needs explaining)</span>
<span class="sd">        alignment (?): (needs explaining)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># a alignment.seq (hopefully!) is a string of letters, with many gaps &quot;-&quot;,</span>
    <span class="c1"># as it this particular case is an alignment sequence.</span>
    <span class="n">seq_indexed</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">alignment</span><span class="p">))</span> <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">]</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;begin: </span><span class="si">{0}</span><span class="s2">; length: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">begin</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">)))</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;alignment: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">alignment</span><span class="p">)))</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;begin&#39;</span><span class="p">:</span> <span class="n">seq_indexed</span><span class="p">[</span>
            <span class="n">begin</span> <span class="o">-</span>
            <span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="n">seq_indexed</span><span class="p">[</span>
            <span class="n">begin</span> <span class="o">+</span>
            <span class="n">length</span> <span class="o">-</span>
            <span class="mi">2</span><span class="p">]}</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


  </body>
</html>